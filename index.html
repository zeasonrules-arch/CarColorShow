<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BYD Showroom Experience</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* UI 容器 */
        #ui-container {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 20px; align-items: center;
            z-index: 999; width: 90%; max-width: 400px;
        }

        /* 磨砂玻璃控制面板 */
        #controls {
            background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(20px);
            padding: 24px 30px; border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; 
            width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        
        .control-item { display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .label { font-size: 10px; opacity: 0.7; letter-spacing: 1.5px; font-weight: 700; color: #fff; text-transform: uppercase; }
        
        /* 颜色选择器样式优化 */
        .color-wrapper {
            position: relative; width: 44px; height: 44px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8); overflow: hidden;
            transition: transform 0.2s; cursor: pointer;
        }
        .color-wrapper:hover { transform: scale(1.1); }
        input[type="color"] { 
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; 
            padding: 0; margin: 0; border: none; cursor: pointer; 
        }

        /* 亮度滑块样式 */
        input[type="range"] { 
            -webkit-appearance: none; width: 140px; height: 4px; 
            background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; 
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; background: #fff; 
            border-radius: 50%; cursor: grab; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }

        #loader {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 14px; letter-spacing: 3px; font-weight: 300;
            text-shadow: 0 0 10px rgba(255,255,255,0.5); pointer-events: none;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <span>LOADING MODEL...</span>
    </div>
    
    <div id="canvas-container"></div>

    <div id="ui-container">
        <div id="controls">
            <div class="control-item">
                <span class="label">Color</span>
                <div class="color-wrapper">
                    <input type="color" id="color-picker" value="#335588"> 
                </div>
            </div>
            <div class="control-item">
                <span class="label">Ambience</span>
                <input type="range" id="brightness-slider" min="0" max="3" step="0.05" value="1.2">
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        let scene, camera, renderer, carModel;
        let lights = {}; 
        let time = 0;

        // 基础光照配置
        const baseIntensity = {
            ambient: 1.0,
            top: 5.0,
            rim: 8.0,
            bottom: 3.0 
        };

        // 1. 车身材质 (Liquid Metal)
        const bodyMaterial = new THREE.MeshPhysicalMaterial({
            color: document.getElementById('color-picker').value,
            metalness: 0.75, 
            roughness: 0.15,      
            clearcoat: 1.0,
            clearcoatRoughness: 0.03, 
            ior: 1.5,             
            envMapIntensity: 1.5,
            side: THREE.DoubleSide
        });

        // 2. 车窗材质 (Black Glass) - 纯黑，高反射
        const glassMaterial = new THREE.MeshPhysicalMaterial({
            color: 0x000000,      // 纯黑
            metalness: 0.9,       // 接近金属的高反射
            roughness: 0.0,       // 镜面光滑
            transmission: 0.0,    // 不透明（隐私玻璃）
            clearcoat: 1.0,
            clearcoatRoughness: 0.0
        });

        // 3. 轮胎/橡胶材质 (Matte Black)
        const rubberMaterial = new THREE.MeshStandardMaterial({
            color: 0x111111,
            roughness: 0.8,
            metalness: 0.1
        });

        init();

        function init() {
            const container = document.getElementById('canvas-container');
            
            // 初始化场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505); 
            scene.fog = new THREE.Fog(0x050505, 10, 60);

            // 相机
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(5.5, 2.5, 6.5);

            // 渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // 控制器
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI - 0.1; 
            controls.minDistance = 3;
            controls.maxDistance = 12;
            controls.autoRotate = true; // 自动旋转展示
            controls.autoRotateSpeed = 1.0;

            setupLights();
            
            // --- 核心修改：自动加载 'car.glb' ---
            // 注意：请确保你的模型文件名为 car.glb 且与 html 在同一目录下
            loadModel('car.glb');

            setupUIListeners();
            window.addEventListener('resize', onResize);
            animate();
        }

        function setupLights() {
            lights.ambient = new THREE.AmbientLight(0xffffff, baseIntensity.ambient);
            scene.add(lights.ambient);

            lights.top = new THREE.DirectionalLight(0xffffff, baseIntensity.top);
            lights.top.position.set(2, 10, 2);
            lights.castShadow = true;
            lights.top.shadow.mapSize.set(2048, 2048);
            lights.top.shadow.bias = -0.0001;
            scene.add(lights.top);

            lights.rim = new THREE.SpotLight(0xddeeff, baseIntensity.rim);
            lights.rim.position.set(-6, 3, -6);
            lights.rim.lookAt(0,0,0);
            scene.add(lights.rim);
            
            lights.bottom = new THREE.SpotLight(0xffaa66, baseIntensity.bottom);
            lights.bottom.position.set(6, -4, 6);
            lights.bottom.lookAt(0,0,0);
            scene.add(lights.bottom);
        }

        function loadModel(url) {
            const loader = new GLTFLoader();
            const loaderUI = document.getElementById('loader');

            loader.load(url, (gltf) => {
                carModel = gltf.scene;

                // --- 智能材质分配逻辑 ---
                carModel.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        
                        // 获取部件名称并转为小写，方便判断
                        const name = child.name.toLowerCase();

                        // 1. 判断是否是玻璃/车窗
                        if (name.includes('window') || name.includes('glass') || name.includes('windshield') || name.includes('screen')) {
                            child.material = glassMaterial;
                        } 
                        // 2. 判断是否是轮胎
                        else if (name.includes('tire') || name.includes('wheel') || name.includes('rubber')) {
                            child.material = rubberMaterial;
                        }
                        // 3. 其他默认视为车身
                        else {
                            child.material = bodyMaterial;
                        }
                    }
                });

                // 自动缩放与居中
                const box = new THREE.Box3().setFromObject(carModel);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 5.0 / maxDim;
                
                carModel.scale.set(scale, scale, scale);
                carModel.position.sub(center.multiplyScalar(scale));
                
                scene.add(carModel);
                loaderUI.style.display = 'none'; // 隐藏加载条

            }, (xhr) => {
                // 加载进度 (可选)
                // console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            }, (error) => {
                console.error(error);
                loaderUI.innerHTML = "<span style='color:red'>ERROR: car.glb NOT FOUND</span>";
                alert('请确保已将模型文件重命名为 "car.glb" 并放在同一目录下！');
            });
        }

        function setupUIListeners() {
            // 颜色选择器
            document.getElementById('color-picker').addEventListener('input', (e) => {
                bodyMaterial.color.set(e.target.value);
            });

            // 亮度控制
            const brightnessSlider = document.getElementById('brightness-slider');
            brightnessSlider.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                lights.ambient.intensity = baseIntensity.ambient * val;
                lights.top.intensity = baseIntensity.top * val;
                lights.rim.intensity = baseIntensity.rim * val;
                lights.bottom.intensity = baseIntensity.bottom * val;
            });
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.005;

            if (carModel) {
                // 悬浮呼吸动画
                carModel.position.y = Math.sin(time) * 0.1;
            }
            // 更新控制器(处理自动旋转)
            // renderer.domElement.parentNode ? null : null; // Hacky check if still attached
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>